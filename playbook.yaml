- name: Setup dotfiles and development environment
  hosts: all
  vars:
    dotfiles_repo: "https://github.com/MoritzKlei/dotfiles.git"
    dotfiles_dir: "{{ ansible_user_dir }}/dotfiles"
    cargo_packages:
      - ripgrep
      - fd-find
      - eza
      - starship
      - zoxide
    go_packages:
      - github.com/jesseduffield/lazygit@latest
      - github.com/jesseduffield/lazydocker@latest
    stow_packages:
      - bash
      - zsh
      - nvim
      - tmux
      - starship
    config_files:
      - path: .bashrc
      - path: .zshrc
      - path: .tmux.conf
      - path: .config/nvim
      - path: .config/starship.toml

  tasks:
    - name: Update apt cache
      become: true
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install apt packages
      become: true
      ansible.builtin.apt:
        name:
          - git
          - curl
          - wget
          - build-essential
          - clang
          - clang-format
          - cmake
          - ninja-build
          - fzf
          - default-jdk
          - lua5.4
          - python3-full
          - python3-pip
          - pipx
          - tmux
          - zsh
          - stow
          - unzip
          - xclip
          - btop
        state: present

    # Go Installation
    - name: Check if Go exists
      ansible.builtin.stat:
        path: /usr/local/go
      register: go_dir

    - name: Install latest Go
      when: not go_dir.stat.exists
      become: true
      block:
        - name: Fetch latest Go version
          ansible.builtin.uri:
            url: https://go.dev/dl/?mode=json
            return_content: true
          register: go_versions

        - name: Download and extract latest Go
          ansible.builtin.unarchive:
            src: "https://go.dev/dl/{{ (go_versions.content | from_json)[0].files | selectattr('os', 'equalto', 'linux') | selectattr('arch', 'equalto', 'amd64') | map(attribute='filename') | first }}"
            dest: /usr/local
            remote_src: true

    # Rust Installation
    - name: Check if cargo exists
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.cargo/bin/cargo"
      register: cargo_exists

    - name: Install Rust
      when: not cargo_exists.stat.exists
      block:
        - name: Download rustup installer
          ansible.builtin.get_url:
            url: https://sh.rustup.rs
            dest: /tmp/sh.rustup.rs
            mode: "0755"

        - name: Run rustup installer
          ansible.builtin.shell: /tmp/sh.rustup.rs -y
          args:
            creates: "{{ ansible_user_dir }}/.cargo/bin/cargo"

        - name: Set rustup default toolchain to stable
          ansible.builtin.shell: |
            source $HOME/.cargo/env
            rustup default stable
          args:
            executable: /bin/bash

    # Cargo packages
    - name: Check installed cargo packages
      ansible.builtin.shell: |
        source $HOME/.cargo/env
        cargo install --list
      args:
        executable: /bin/bash
      register: cargo_list
      changed_when: false
      failed_when: false

    - name: Install cargo packages
      ansible.builtin.shell: |
        source $HOME/.cargo/env
        cargo install {{ item }}
      args:
        executable: /bin/bash
      loop: "{{ cargo_packages }}"
      when: "item not in cargo_list.stdout"

    # Docker Installation
    - name: Check if Docker exists
      ansible.builtin.stat:
        path: /usr/bin/docker
      register: docker_exists

    - name: Install Docker
      when: not docker_exists.stat.exists
      become: true
      block:
        - name: Download Docker installation script
          ansible.builtin.get_url:
            url: https://get.docker.com
            dest: /tmp/get-docker.sh
            mode: "0755"

        - name: Run Docker installation script
          ansible.builtin.shell: /tmp/get-docker.sh
          args:
            creates: /usr/bin/docker

    - name: Add user to docker group
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: true

    - name: Reset connection to apply group membership
      ansible.builtin.meta: reset_connection

    # Neovim Installation
    - name: Check if Neovim exists
      ansible.builtin.stat:
        path: /opt/nvim-linux-x86_64
      register: nvim_dir

    - name: Install latest Neovim
      when: not nvim_dir.stat.exists
      become: true
      block:
        - name: Get latest Neovim release
          ansible.builtin.uri:
            url: https://api.github.com/repos/neovim/neovim/releases/latest
            return_content: true
          register: nvim_release

        - name: Download and extract latest Neovim
          ansible.builtin.unarchive:
            src: "https://github.com/neovim/neovim/releases/download/{{ nvim_release.json.tag_name }}/nvim-linux-x86_64.tar.gz"
            dest: /opt
            remote_src: true

    # Go packages
    - name: Install Go packages
      ansible.builtin.shell: |
        export PATH=$PATH:/usr/local/go/bin
        go install {{ item }}
      environment:
        GOPATH: "{{ ansible_user_dir }}/go"
      loop: "{{ go_packages }}"
      register: go_install
      changed_when: "'downloading' in go_install.stderr"

    # Dotfiles management
    - name: Check if running inside dotfiles repository
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/.git"
      register: playbook_is_repo

    - name: Set dotfiles directory to playbook dir if running via ansible-pull
      ansible.builtin.set_fact:
        dotfiles_dir: "{{ playbook_dir }}"
      when: playbook_is_repo.stat.exists

    - name: Manage dotfiles repository
      when: not playbook_is_repo.stat.exists
      ansible.builtin.git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_dir }}"
        version: main
        update: true

    - name: Update dotfiles when running via ansible-pull
      when: playbook_is_repo.stat.exists
      ansible.builtin.command:
        cmd: git pull --rebase origin main
        chdir: "{{ dotfiles_dir }}"
      register: git_pull_result
      changed_when: "'Already up to date' not in git_pull_result.stdout"
      failed_when: git_pull_result.rc != 0 and 'Already up to date' not in git_pull_result.stdout

    - name: Initialize and update git submodules
      ansible.builtin.command:
        cmd: git submodule update --init --remote --merge
        chdir: "{{ dotfiles_dir }}"
      register: submodule_result
      changed_when: submodule_result.rc == 0

    # Remove existing config files
    - name: Check existing config files
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/{{ item.path }}"
      loop: "{{ config_files }}"
      register: config_stat

    - name: Remove existing config files if not symlinks
      ansible.builtin.file:
        path: "{{ item.item.path }}"
        state: absent
      loop: "{{ config_stat.results }}"
      when:
        - item.stat.exists
        - not item.stat.islnk

    # Stow dotfiles
    - name: Stow dotfiles
      ansible.builtin.command:
        cmd: stow -t {{ ansible_user_dir }} {{ item }}
        chdir: "{{ dotfiles_dir }}"
      loop: "{{ stow_packages }}"
      register: stow_result
      changed_when: stow_result.rc == 0
      failed_when: stow_result.rc != 0

    # Install tmux plugins
    - name: Install tmux plugins via TPM
      ansible.builtin.shell: "{{ ansible_user_dir }}/.tmux/plugins/tpm/bin/install_plugins"
      register: tpm_install
      changed_when: "'Already installed' not in tpm_install.stdout"
      failed_when: false

    # Set default shell
    - name: Change default shell to zsh
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/bin/zsh

    # Final system update
    - name: Upgrade all packages
      become: true
      ansible.builtin.apt:
        upgrade: dist
        update_cache: true
